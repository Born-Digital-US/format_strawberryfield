<?php

namespace Drupal\format_strawberryfield\Form;

use Drupal\Core\Form\ConfigFormBase;
use Drupal\Core\Form\FormStateInterface;
use GuzzleHttp\Exception\ConnectException;
use Symfony\Component\DependencyInjection\ContainerInterface;
use GuzzleHttp\ClientInterface;
use GuzzleHttp\Client;
use GuzzleHttp\Exception\ClientException;
use GuzzleHttp\Exception\ServerException;
use Drupal\Core\Config\ConfigFactoryInterface;

/**
 * Class IiifSettingsForm.
 */
class IiifSettingsForm extends ConfigFormBase {


  /**
   * The HTTP client to check if IIIF servers are there.
   *
   * @var \GuzzleHttp\Client
   */
  protected $httpClient;

  /**
   * Constructs a \Drupal\system\ConfigFormBase object.
   *
   * @param \Drupal\Core\Config\ConfigFactoryInterface $config_factory
   *   The factory for configuration objects.
   */
  public function __construct(ConfigFactoryInterface $config_factory, ClientInterface $httpClient) {
    $this->setConfigFactory($config_factory);
    $this->httpClient = $httpClient;
  }

  /**
   * {@inheritdoc}
   */
  public static function create(ContainerInterface $container) {
    return new static(
      $container->get('config.factory'),
      $container->get('http_client')
    );
  }


  /**
   * {@inheritdoc}
   */
  protected function getEditableConfigNames() {
    return [
      'format_strawberryfield.iiif_settings',
    ];
  }

  /**
   * {@inheritdoc}
   */
  public function getFormId() {
    return 'format_strawberryfield_iiif_settings_form';
  }

  /**
   * {@inheritdoc}
   */
  public function buildForm(array $form, FormStateInterface $form_state) {
    $config = $this->config('format_strawberryfield.iiif_settings');
    $form['info'] = [
      '#markup' => $this->t('This IIIF Server configuration URLs are used as defaults for field formatters using IIIF, but can be overriden on a one by one basis when setting up your formatters for each Display Mode.'),
      ];

    $form['pub_server_url'] = [
      '#type' => 'url',
      '#title' => $this->t('Base URL of your IIIF Media Server public accesible from the Outside World.'),
      '#description' => $this->t('Please provide a publicly accessible IIIF server URL. This URL will be used for AJAX and JS calls. Trailing Slashes will be removed.'),
      '#default_value' => !empty($config->get('pub_server_url')) ? $config->get('pub_server_url') : 'http://localhost:8183/iiif/2',
      '#required' => TRUE
    ];

    $form['int_server_url'] = [
      '#type' => 'url',
      '#title' => $this->t('Base URL of your IIIF Media Server accesible from inside this Webserver.'),
      '#description' => $this->t('Please provide Internal IIIF server URL. This URL will be used by Internal Server calls and needs to be locally accesible by your server, e.g 127.0.0.1 or an local Docker alias. Trailing Slashes will be removed.'),
      '#default_value' => !empty($config->get('int_server_url')) ? $config->get('int_server_url') : 'http://esmero-cantaloupe:8182/iiif/2',
      '#required' => TRUE
    ];

    return parent::buildForm($form, $form_state);
  }

  /**
   * @inheritDoc
   */
  public function validateForm(array &$form, FormStateInterface $form_state) {
    // Don't validate External one, since PHP could probably fail.
    try {
      /* @var Client $this->httpClient  */
      $response = $this->httpClient
        ->head(
          $form_state
            ->getValue('int_server_url')
        );
      }
    catch(ConnectException $exception) {
      $responseMessage = $exception->getMessage();
      $form_state->setErrorByName('int_server_url', t("We could not contact your Public IIIF server: @error", [
        '@error' => $responseMessage
      ]));
    }
      catch(ClientException $exception) {
        $responseMessage = $exception->getMessage();
        $form_state->setErrorByName('int_server_url', t("We could not contact your Public IIIF server: @error", [
        '@error' => $responseMessage
      ]));
      }
      catch (ServerException $exception) {
        $responseMessage = $exception->getMessage();
        $form_state->setErrorByName('int_server_url', t("We could not contact your Public IIIF server: @error", [
          '@error' => $responseMessage
        ]));
      }

    parent::validateForm(
      $form,
      $form_state
    ); // TODO: Change the autogenerated stub
  }

  /**
   * {@inheritdoc}
   */
  public function submitForm(array &$form, FormStateInterface $form_state) {
    $this->config('format_strawberryfield.iiif_settings')
      ->set('pub_server_url', rtrim($form_state->getValue('pub_server_url'),"/"))
      ->set('int_server_url',  rtrim($form_state->getValue('int_server_url'),"/"))
      ->save();

    parent::submitForm($form, $form_state);
  }

}